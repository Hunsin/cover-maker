<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="hammer.html">
<dom-module id="cover-editor">
	<style>
		:host {
			display: block;
			margin-top: 1em;
			width: 100%;
		}
		
		* {
			box-sizing: border-box;
		}

		.experience-text {
			margin: 0 0 0 240px;
		    
		    width: 690px;
			height: 22px;
		    line-height: 22px;
		    
		    text-align: right;
		}
		
		.experience-text:first-child {
			margin-top: 12px;
			margin-right: 30px;
		}
		
		input, textarea {
			border: none;
			padding: 0;
			
			overflow: hidden;
		
			@apply(--paper-font-common-base);
			font-size: 16px;
		}
		
		.img-area {
			background-image: url("transparent.png");
			background-repeat: repeat;
			overflow: hidden;
		}
		
		.img-area img {
			position: relative;
			height: auto;
		}

		.text-red {
			margin: 0 4px;
			
			width: 22px;
			height: 22px;
		}
		
		input.text-red:checked + .experience-text {
			color: #F00;
		}
		
		#cover-background {
			position: relative;
	
			width: inherit;
			height: 430px;
		}

		#cover-container {
			display: block;
			position: relative;
			margin: 0 auto;
			width: 960px;
			height: 540px;
		}

		#cover-info {
		    position: absolute;
		    top: 222px;
		}
		
		#cover-info textarea {
			padding: 8px;
			margin: 8px;
			
		    width: calc(100% - 16px);
		    height: calc(100% - 16px);
		    line-height: 24px;
		    
		    resize: none;
		    background-color: rgba(255, 255, 255, 0.4);
		}

		#info-ctrl {
			position: absolute;
			bottom: 0;

			width: 24px;
			height: 24px;

			background-color: red;
		}

		#cover-location {
			position: absolute;
			top: 390px;
			
			width: 160px;
			height: 40px;
			line-height: 40px;
			
			text-align: center;
			background-color: transparent;
		}
		
		#experience-box {
		    position: absolute;
		    top: 430px;

			display: -webkit-flex;
			display: -ms-flexbox;
			display: flex;
			-webkit-flex-flow: row-reverse wrap;
			flex-flow: row-reverse wrap;
			align-content: flex-start;
		    width: inherit;
		    height: 110px;
			
		    background-image: url(poster-brand.png);
		    background-size: cover;
		}
		
		#cover-avatar {
			position: absolute;
			top: 230px;
			
			width: 160px;
			height: 160px;
			border: 5px solid;
			border-color: #FFF;
		}
	</style>
	
	<template>
		<div id="cover-container">

			<!-- background image -->
			<div class="img-area" id="cover-background">
				<img id="background" src="[[speaker.background.URL]]"
					 style$="top: [[speaker.background.Top]]px; left: [[speaker.background.Left]]px; width: [[speaker.background.Width]]px">
			</div>

			<!-- avatar image -->
			<div class="img-area" id="cover-avatar"
				 style$="left: [[speaker.avatarPosition]]px;"> 
				<img id="avatar" src="[[speaker.avatar.URL]]"
					 style$="top: [[speaker.avatar.Top]]px; left: [[speaker.avatar.Left]]px; width: [[speaker.avatar.Width]]px">
			</div>

			<!-- location -->
			<input id="cover-location" type="text" value="{{speaker.location::input}}" placeholder="地點：請輸入地點"
				   style$="left: [[speaker.avatarPosition]]px; color: [[speaker.locationColor]]">

			<!-- info -->
			<div id="cover-info"
				 style$="[[_infoPosition(speaker.avatarPosition)]] width: [[speaker.info.Width]]px; height: [[speaker.info.Height]]px;">
				<textarea value="{{speaker.info.Text::input}}" placeholder="嗨～"></textarea>
				<div id="info-ctrl" style$="[[_infoCtrlPosition(speaker.avatarPosition)]]"></div>
			</div>

			<div id="experience-box">
				<input class="experience-text" type="text" value={{speaker.name::input}} placeholder="點擊輸入大名">
				<input class="text-red" name="text_red" type="radio" value=1
					   checked="{{_isFocus(speaker.experienceFocus, 1)}}" on-change="_changeFocus">
				<input class="experience-text" type="text" value={{speaker.experience.0::input}} placeholder="輸入學經歷 如：MIT Media Lab, Master of Science Media Arts and Science 碩士, 20xx">
				<input class="text-red" name="text_red" type="radio" value=2
					   checked="{{_isFocus(speaker.experienceFocus, 2)}}" on-change="_changeFocus">
				<input class="experience-text" type="text" value={{speaker.experience.1::input}} placeholder="輸入學經歷">
				<input class="text-red" name="text_red" type="radio" value=3
					   checked="{{_isFocus(speaker.experienceFocus, 3)}}" on-change="_changeFocus">
				<input class="experience-text" type="text" value={{speaker.experience.2::input}} placeholder="輸入學經歷">
			</div>
		</div>

		<!-- control panel -->
		<div>
			選擇背景圖片：<input class="upload-img" name="background" type="file" accept="image/*" on-change="sendImg"><br>
			選擇大頭貼照：<input class="upload-img" name="avatar" type="file" accept="image/*" on-change="sendImg"><br>
			大頭貼位置：
			<input type="button" value="左側" on-tap="togglePosition">
			<input type="button" value="右側" on-tap="togglePosition">
			<input type="button" value="不顯示" on-tap=""><br>
			地點文字顏色：
			<input type="button" value="白色" on-tap="toggleTextColor">
			<input type="button" value="黑色" on-tap="toggleTextColor">
			<a href$="/export/[[speaker.id]]" target="_blank">輸出海報！</a>
		</div>
	</template>
	
	<script>
		Polymer({
			is: "cover-editor",
			properties: {
				speaker: {
					type: Object,
					notify: true
				}
			},
			ready: function() {
				/*global Hammer*/
				"use strict";

				var self = this,
					imgBackground = this.querySelector("#background"),
					imgAvatar = this.querySelector("#avatar"),
					infoContainer = this.querySelector("#cover-info"),
					infoCtrl = this.querySelector("#info-ctrl");

				// image pan, zoom by touchscreen or mouse
				function hmImage(element) {
					var hm = new Hammer.Manager(element);

					// update new offset value to image
					function gestureEnd(e) {
						e.preventDefault();
						var img = self.speaker[e.target.id];
						img.Width = e.target.offsetWidth;
						img.Top = e.target.offsetTop;
						img.Left = e.target.offsetLeft;
						self.notifyPath("speaker." + e.target.id, img);
					}

					// center position assigned by Hammer.js is relative to window,
					// we convert it to which relative to its parent element
					function gestureOn(e) {
						e.preventDefault();
						var gestureEvent = e;
						gestureEvent.center = {
							x: e.center.x - e.target.parentElement.getBoundingClientRect().left,
							y: e.center.y - e.target.parentElement.getBoundingClientRect().top
						};
						imgZoom(gestureEvent);
					}

					function imgZoom(e) {
						var img = self.speaker[e.target.id];
						e.target.style.width = parseInt(img.Width * e.scale, 10) + "px";
						e.target.style.top = parseInt(e.center.y - (e.scale * (e.center.y - img.Top)) + e.deltaY, 10) + "px";
						e.target.style.left = parseInt(e.center.x - (e.scale * (e.center.x - img.Left)) + e.deltaX, 10) + "px";
					}

					// deltaX, deltaY are read-only in wheel event, so we create new event object
					function onMousewheel(e) {
						e.preventDefault();
						var wheelEvent = {
							deltaX: 0,
							deltaY: 0,
							center: {
								x: e.offsetX + e.target.offsetLeft,
								y: e.offsetY + e.target.offsetTop
							},
							scale: (e.deltaY > 0)? 1.05 : (1 / 1.05),
							target: e.target,
							preventDefault: function(){}
						};
						imgZoom(wheelEvent);
						gestureEnd(wheelEvent);
					}

					element.addEventListener("wheel", onMousewheel, false);

					hm.add(new Hammer.Pan({threshold: 0, pointers: 0}));
					hm.add(new Hammer.Pinch({threshold: 0})).recognizeWith(hm.get("pan"));

					hm.on("panmove pinchin pinchout", gestureOn);
					hm.on("panend", gestureEnd);
				}

				// info box resize by paning an element at the corner
				function hmInfo() {
					var hm = new Hammer.Manager(infoCtrl);

					function infoResize(e) {
						e.preventDefault();
						var dir = (self.speaker.avatarPosition == 768)? -1 : 1;
						infoContainer.style.width = self.speaker.info.Width + (dir * (parseInt(e.deltaX / 16, 10) * 16)) + "px";
						infoContainer.style.height = self.speaker.info.Height + (parseInt(e.deltaY / 16, 10) * 16) + "px";
					}
					
					function infoResizeEnd(e) {
						e.preventDefault();
						var info = self.speaker.info;
						info.Width = infoContainer.offsetWidth;
						info.Height = infoContainer.offsetHeight;
						self.notifyPath("speaker.info", info);
					}

					hm.add(new Hammer.Pan({threshold: 0, pointers: 0}));
					hm.on("panmove", infoResize);
					hm.on("panend", infoResizeEnd);
				}

				hmImage(imgBackground);
				hmImage(imgAvatar);
				hmInfo();
			},

			togglePosition: function(e) {
				if (e.target.value == "左側") {
					this.set("speaker.avatarPosition", 32);
				}
				else {
					this.set("speaker.avatarPosition", 768);
				}
			},

			toggleTextColor: function(e) {
				if (e.target.value == "白色") {
					this.set("speaker.locationColor", "white");
				}
				else {
					this.set("speaker.locationColor", "black");
				}
			},

			sendImg: function(e) {
				var formData = new FormData(),
					xhr = new XMLHttpRequest(),
					img = e.target.files[0],
					imgName = e.target.name, // avatar or background
					userId = this.speaker.id;

				// return if not select any image
				if (!img) return;

				formData.append("img", img);

				xhr.open("POST", "/upload/" + userId + "/" + imgName, true);
				xhr.onload = function() {
					if (this.status != 200) console.log("error");
				};
				xhr.send(formData);
			},

			_infoPosition: function(avatarPosition) {
				return (avatarPosition == 768)? "right: 204px;" : "left: 208px;";
			},

			_infoCtrlPosition: function(avatarPosition) {
				return (avatarPosition == 768)? "left: 0; cursor: sw-resize; border-top-right-radius: 50%;" : "right: 0; cursor: se-resize; border-top-left-radius: 50%;";
			},

			_isFocus: function(num1, num2) { 
				return num1 == num2;
			},

			_changeFocus: function(e) {
				this.set("speaker.experienceFocus", e.target.value);
			}
		});
	</script>
</dom-module>